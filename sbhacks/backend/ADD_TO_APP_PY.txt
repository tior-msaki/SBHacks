# Add these imports at the top of app.py
from elevenlabs.client import ElevenLabs
from fastapi.responses import Response

# Add this model class with your other Pydantic models (around line 44)
class TextToSpeechRequest(BaseModel):
    text: str
    avatar: int  # 1 = Berta, 2 = Andrew, 3 = Sophia
    model_ver: str = "eleven_multilingual_v2"

# Add these constants after your imports (around line 16)
MODEL_VERSION = "eleven_multilingual_v2"

VOICE_IDS = {
    1: "KnTv6RLzB4khP0x7xem1",  # Berta
    2: "WLOYW6YwyA4c6LBQKJ36",  # Andrew
    3: "l2xKdzGYYWPy0gKbjRXC"   # Sophia
}

# Add this endpoint function with your other endpoints (before the if __name__ == "__main__" block)
@app.post('/text-to-speech')
async def text_to_speech(request: TextToSpeechRequest):
    """Generate speech using ElevenLabs API"""
    try:
        print(f"TTS Request: avatar={request.avatar}, text_length={len(request.text)}")
        
        elevenlabs = ElevenLabs(
            api_key=os.getenv("ELEVENLABS_API_KEY"),
        )

        # Get voice ID for the avatar
        voice_id = VOICE_IDS.get(request.avatar, VOICE_IDS[1])
        print(f"Using voice_id: {voice_id} for avatar {request.avatar}")
        
        # Generate audio
        audio = elevenlabs.text_to_speech.convert(
            text=request.text,
            voice_id=voice_id,
            model_id=request.model_ver,
            output_format="mp3_44100_128",
        )

        # Read the audio bytes
        audio_bytes = b""
        for chunk in audio:
            audio_bytes += chunk

        print(f"Generated audio: {len(audio_bytes)} bytes")
        
        # Return audio as MP3
        return Response(
            content=audio_bytes,
            media_type="audio/mpeg",
            headers={
                "Content-Disposition": f"attachment; filename=speech.mp3"
            }
        )
    except Exception as e:
        print(f"TTS Error: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))
